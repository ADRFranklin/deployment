version: "3.5"

networks:
    default:
        external:
            name: gateway
    database:
        driver: bridge
        internal: true

services:
    mybb:
        image: mybb/mybb:latest
        volumes:
            - ${DATA_DIR}/burgershot/mybb:/var/www/html:rw
        networks:
            - database
            - default
        labels:
            - traefik.enable=false

    nginx:
        image: nginx:mainline
        volumes:
            - ./nginx.conf:/etc/nginx/nginx.conf:ro
            - ${DATA_DIR}/burgershot/mybb:/var/www/html:ro
        labels:
            - traefik.enable=true
            - traefik.docker.network=gateway
            - traefik.frontend.rule=Host:www.burgershot.gg,burgershot.gg
            - traefik.frontend.headers.SSLRedirect=true
            - traefik.frontend.headers.SSLHost=www.burgershot.gg
            - traefik.frontend.redirect.regex=^https?://[a-z0-9.]+/(.*)
            - traefik.frontend.redirect.replacement=https://www.burgershot.gg/$${1}
            - traefik.port=80
        networks:
            - default

    postgresql:
        image: postgres:10.4
        environment:
            POSTGRES_DB: burgershot
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
            POSTGRES_USER: burgershot
        networks:
            - database
        volumes:
            - ${DATA_DIR}/burgershot/postgres/data:/var/lib/postgresql/data
